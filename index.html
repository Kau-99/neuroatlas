<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroAtlas 9.5: Conte√∫do Profundo</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fontes T√©cnicas -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@400;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- √çcones -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
 <style>
    :root {
        --neon-cyan: #00f3ff;
        --neon-purple: #bc13fe;
        --alert-red: #ff2a2a;
        --serotonin-green: #00ff9d;
        --dopamine-gold: #ffcc00;
        --bg-dark: #020408;
        --glass-panel: rgba(8, 12, 24, 0.90);
        --border-tech: 1px solid rgba(0, 243, 255, 0.2);
    }

    body {
        margin: 0;
        overflow: hidden;
        background-color: var(--bg-dark);
        font-family: 'Rajdhani', sans-serif;
        color: #e2e8f0;
        user-select: none;
    }

    /* Respeita notch / √°rea segura em iOS */
    @supports (padding: max(0px)) {
        body {
            padding-top: env(safe-area-inset-top);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
        }
    }

    /* --- UI LAYOUT --- */
    #ui-layer {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
        z-index: 10;
        background: radial-gradient(circle at center, transparent 20%, #000 150%);
    }

    .hud-header {
        position: absolute;
        top: 25px; left: 30px;
        pointer-events: auto;
    }
    h1 {
        font-family: 'JetBrains Mono', monospace;
        color: var(--neon-cyan);
        font-size: clamp(1.5rem, 3vw, 2.5rem);
        letter-spacing: -1px;
        margin: 0;
        text-transform: uppercase;
    }
    .subtitle {
        font-family: 'Inter', sans-serif;
        font-size: 0.9rem;
        color: #64748b;
        border-left: 2px solid var(--neon-purple);
        padding-left: 12px;
    }

    /* BOOT SCREEN (cinematogr√°fico) */
    #boot-screen {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at center, #020617 0, #000 70%);
        color: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        pointer-events: auto;
        font-family: 'JetBrains Mono', monospace;
        transition: opacity 0.6s;
    }
    .boot-inner {
        width: min(600px, 90vw);
        background: rgba(2, 6, 23, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.4);
        box-shadow: 0 0 40px rgba(0, 243, 255, 0.25);
        padding: 24px 20px 18px;
        position: relative;
        overflow: hidden;
    }
    .boot-title {
        font-size: 0.9rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--neon-cyan);
        margin-bottom: 4px;
    }
    .boot-sub {
        font-size: 0.8rem;
        color: #94a3b8;
        margin-bottom: 12px;
    }
    .boot-log {
        font-size: 0.75rem;
        line-height: 1.5;
        max-height: 200px;
        overflow-y: auto;
        padding-right: 6px;
        border-top: 1px solid rgba(51, 65, 85, 0.8);
        border-bottom: 1px solid rgba(51, 65, 85, 0.8);
        padding-top: 6px;
        padding-bottom: 6px;
    }
    .boot-log div {
        white-space: pre;
    }
    .boot-scan-line {
        position: absolute;
        top: 0;
        left: 0;
        width: 120%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
        opacity: 0.6;
        animation: bootScan 2s linear infinite;
    }
    @keyframes bootScan {
        0% { transform: translateX(-20%); }
        100% { transform: translateX(20%); }
    }
    .boot-btn {
        margin-top: 10px;
        font-size: 0.8rem;
        padding: 8px 18px;
        border-radius: 999px;
        border: 1px solid var(--neon-cyan);
        background: transparent;
        color: var(--neon-cyan);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.12em;
    }
    .boot-btn:hover {
        background: var(--neon-cyan);
        color: #020617;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.6);
    }

    /* START OVERLAY (Necess√°rio para √Åudio) */
    #start-screen {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(2, 4, 8, 0.95);
        z-index: 9999;
        display: none; /* come√ßa escondido, s√≥ aparece ap√≥s o boot */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        pointer-events: auto;
        transition: opacity 0.8s;
        opacity: 0;
    }
    .start-btn {
        padding: 15px 40px;
        font-family: 'JetBrains Mono';
        font-size: 1.2rem;
        background: transparent;
        color: var(--neon-cyan);
        border: 1px solid var(--neon-cyan);
        cursor: pointer;
        margin-top: 20px;
        transition: 0.3s;
    }
    .start-btn:hover {
        background: var(--neon-cyan);
        color: #000;
        box-shadow: 0 0 30px var(--neon-cyan);
    }

    /* BREATHING PACER (Terapia Visual) */
    #breathing-pacer {
        position: absolute;
        bottom: 120px; left: 50%;
        transform: translateX(-50%);
        pointer-events: none;
        display: none; /* Ativado via JS */
        flex-direction: column;
        align-items: center;
        opacity: 0;
        transition: opacity 1s;
    }
    .breath-circle {
        width: 60px; height: 60px;
        border-radius: 50%;
        background: rgba(0, 243, 255, 0.2);
        border: 2px solid var(--neon-cyan);
        box-shadow: 0 0 20px var(--neon-cyan);
        animation: breathe 8s infinite ease-in-out; /* 4-7-8 Rhythm adaptation */
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: 'JetBrains Mono';
        font-size: 0.8rem;
        color: #fff;
    }
    .breath-text {
        margin-top: 10px;
        font-family: 'Inter';
        font-size: 0.9rem;
        color: #fff;
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
    }
    @keyframes breathe {
        0%, 100% { transform: scale(1); border-color: var(--neon-cyan); background: rgba(0,243,255,0.2); }
        40% { transform: scale(2.5); border-color: #fff; background: rgba(0,243,255,0.4); } /* Inspire */
        60% { transform: scale(2.5); } /* Segure */
    }

    /* MUTE BUTTON */
    .audio-toggle {
        position: absolute;
        top: 30px; right: 30px;
        color: var(--neon-cyan);
        font-size: 1.5rem;
        cursor: pointer;
        pointer-events: auto;
        opacity: 0.7;
        transition: 0.3s;
    }
    .audio-toggle:hover { opacity: 1; text-shadow: 0 0 10px var(--neon-cyan); }

    /* MONITOR NEUROQU√çMICO */
    .chem-monitor {
        position: absolute;
        top: 50%; right: 30px;
        transform: translateY(-50%);
        width: 220px;
        background: var(--glass-panel);
        backdrop-filter: blur(10px);
        border: var(--border-tech);
        padding: 20px;
        pointer-events: auto;
        border-right: 2px solid var(--neon-cyan);
    }
    .chem-title { font-family: 'JetBrains Mono'; font-size: 0.75rem; color: #94a3b8; margin-bottom: 15px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
    .chem-row { margin-bottom: 12px; }
    .chem-label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px; font-family: 'Inter'; }
    .progress-bg { height: 4px; background: rgba(255,255,255,0.1); width: 100%; position: relative; }
    .progress-fill { height: 100%; width: 50%; background: var(--neon-cyan); transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1); position: relative; }
    #chem-chart {
        width: 100%;
        height: auto;
        margin-top: 10px;
        border-radius: 4px;
        background: rgba(15,23,42,0.9);
    }

    /* CONTROLES ESQUERDA */
    .sim-controls {
        position: absolute;
        top: 50%; left: 30px;
        transform: translateY(-50%);
        width: 200px;
        pointer-events: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .sim-btn {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.1);
        color: #94a3b8;
        padding: 12px;
        font-family: 'JetBrains Mono';
        font-size: 0.8rem;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .sim-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .sim-btn.active {
        background: rgba(0, 243, 255, 0.1);
        border-color: var(--neon-cyan);
        color: var(--neon-cyan);
        box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        font-weight: bold;
    }
    .sim-btn.anxiety-mode.active {
        border-color: var(--alert-red);
        color: var(--alert-red);
        background: rgba(255, 42, 42, 0.1);
        box-shadow: 0 0 15px rgba(255, 42, 42, 0.2);
    }
    .sim-btn.depress-mode.active {
        border-color: #64748b;
        color: #cbd5e1;
        background: rgba(100, 116, 139, 0.1);
    }

    /* LABELS 3D */
    .hotspot-label {
        position: absolute;
        font-family: 'JetBrains Mono';
        font-size: 0.7rem;
        color: var(--neon-cyan);
        text-shadow: 0 0 5px rgba(0,0,0,1);
        pointer-events: none;
        opacity: 0.8;
        background: rgba(0,0,0,0.6);
        padding: 2px 5px;
        border-radius: 2px;
        border: 1px solid rgba(0, 243, 255, 0.3);
        transition: opacity 0.3s;
    }
    .line-connector {
        position: absolute;
        background: var(--neon-cyan);
        width: 1px;
        height: 20px;
        transform-origin: top;
        top: 100%; left: 50%;
    }

    /* MODAL */
    .modal-content {
        background: rgba(5, 8, 15, 0.98);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid var(--neon-cyan);
        border-radius: 0;
        box-shadow: 0 20px 50px rgba(0,0,0,0.9);
    }
    .modal-title {
        font-family: 'JetBrains Mono';
        letter-spacing: -1px;
        color: #fff;
        font-size: 1.1rem;
    }
    .nav-tabs .nav-link {
        color: #64748b;
        font-family: 'JetBrains Mono';
        font-size: 0.8rem;
        border:none;
    }
    .nav-tabs .nav-link.active {
        background: transparent;
        color: var(--neon-cyan);
        border-bottom: 2px solid var(--neon-cyan);
    }
    .science-box {
        background: rgba(0, 243, 255, 0.05);
        border-left: 3px solid var(--neon-cyan);
        padding: 15px;
        margin-top: 15px;
        font-size: 0.9rem;
    }
    .behavior-list li { margin-bottom: 8px; color: #cbd5e1; }
    .behavior-list strong { color: var(--neon-cyan); }
    .mode-indicator {
        font-size: 0.7rem;
        text-transform: uppercase;
        margin-bottom: 10px;
        display: inline-block;
        padding: 2px 6px;
        border-radius: 2px;
    }

    /* Sess√µes Guiadas */
    .session-panel {
        position: absolute;
        bottom: 25px;
        left: 30px;
        width: 230px;
        background: rgba(10, 16, 32, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.4);
        border-radius: 8px;
        padding: 10px 10px 8px;
        pointer-events: auto;
        backdrop-filter: blur(10px);
    }
    .session-title {
        font-family: 'JetBrains Mono';
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #94a3b8;
        margin-bottom: 4px;
    }
    .session-select {
        width: 100%;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(51, 65, 85, 0.9);
        color: #e5e7eb;
        font-family: 'JetBrains Mono';
        font-size: 0.7rem;
        padding: 4px 6px;
        margin-bottom: 6px;
    }
    .session-buttons {
        display: flex;
        gap: 6px;
        margin-bottom: 4px;
    }
    .session-btn {
        flex: 1;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        font-family: 'JetBrains Mono';
        font-size: 0.7rem;
        padding: 3px 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        cursor: pointer;
    }
    .session-btn.stop {
        border-color: rgba(248, 113, 113, 0.7);
        color: #fecaca;
    }
    .session-btn:hover {
        box-shadow: 0 0 12px rgba(148, 163, 184, 0.4);
    }
    .session-status {
        font-size: 0.65rem;
        color: #94a3b8;
        min-height: 14px;
    }

    /* Grid / HUD extra (V2) */
    .neuro-grid {
        position: absolute;
        inset: 0;
        background-image:
            linear-gradient(rgba(148, 163, 184, 0.04) 1px, transparent 1px),
            linear-gradient(90deg, rgba(148, 163, 184, 0.04) 1px, transparent 1px);
        background-size: 40px 40px;
        mix-blend-mode: screen;
        opacity: 0.5;
        pointer-events: none;
        z-index: -1;
    }

    .hud-header::after {
        content: "";
        display: block;
        margin-top: 8px;
        width: 140px;
        height: 2px;
        background: linear-gradient(90deg, var(--neon-cyan), transparent);
        animation: hudScan 3s infinite alternate;
        opacity: 0.7;
    }

    @keyframes hudScan {
        0% { transform: translateX(0); opacity: 0.4; }
        100% { transform: translateX(40px); opacity: 1; }
    }

    .sim-btn.perf-toggle {
        border-style: dashed;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        opacity: 0.8;
    }

    .sim-btn.perf-toggle.active {
        border-color: var(--serotonin-green);
        color: var(--serotonin-green);
        box-shadow: 0 0 15px rgba(0, 255, 157, 0.25);
        opacity: 1;
    }

    .neuro-footer {
        position: absolute;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%);
        pointer-events: auto;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem;
        color: #64748b;
        background: rgba(2, 4, 8, 0.8);
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        backdrop-filter: blur(10px);
    }

    .neuro-footer span {
        opacity: 0.8;
    }

    .neuro-footer button {
        border: none;
        background: transparent;
        color: var(--neon-cyan);
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 0 6px;
        cursor: pointer;
    }

    .neuro-footer button:hover {
        text-shadow: 0 0 10px var(--neon-cyan);
    }

    /* Modal cient√≠fico extra */
    #science-modal .modal-content {
        border-top-color: var(--neon-purple);
    }

    #science-modal .science-section-title {
        font-family: 'JetBrains Mono';
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--neon-cyan);
        margin-bottom: 6px;
    }

    #science-modal .science-chip {
        display: inline-block;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        padding: 3px 9px;
        font-size: 0.7rem;
        margin: 2px 3px;
        color: #cbd5e1;
    }

    #science-modal .science-chip strong {
        color: var(--neon-cyan);
    }

    #science-modal small {
        color: #64748b;
    }

    /* ---------- BREAKPOINTS ---------- */

    /* Tablets / telas intermedi√°rias ‚Äì ajusta sem esconder conte√∫do */
    @media (max-width: 1024px) {
        .chem-monitor {
            right: 16px;
            width: 200px;
        }

        .session-panel {
            left: 16px;
            bottom: 20px;
        }

        .sim-controls {
            left: 16px;
        }
    }

    /* Mobile / Tablets em p√© */
    @media (max-width: 768px) {
        html, body {
            overflow: hidden;
        }

        h1 {
            font-size: 1.35rem;
        }

        .hud-header {
            top: 12px;
            left: 12px;
            max-width: 65vw;
        }

        .subtitle {
            font-size: 0.75rem;
        }

        .audio-toggle {
            top: 12px;
            right: 12px;
            font-size: 1.3rem;
        }

        /* Em mobile, foco total no c√©rebro 3D:
           escondemos monitor qu√≠mico e painel de sess√µes */
        .chem-monitor,
        .session-panel {
            display: none;
        }

        /* Controles viram barra horizontal pr√≥xima ao rodap√© */
        .sim-controls {
            top: auto;
            bottom: 72px;
            left: 8px;
            width: calc(100% - 16px);
            transform: none;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 6px;
            overflow-x: auto;
            padding: 4px 0 2px;
        }

        .sim-controls .sim-btn {
            flex: 0 0 auto;
            padding: 8px 10px;
            font-size: 0.7rem;
            white-space: nowrap;
        }

        /* Rodap√© centralizado, sem conflito com os controles */
        .neuro-footer {
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            max-width: calc(100% - 20px);
            padding: 6px 10px;
            font-size: 0.65rem;
            justify-content: center;
            text-align: center;
        }

        /* Pacer de respira√ß√£o mais central para n√£o colidir com footer/controles */
        #breathing-pacer {
            bottom: 50%;
            transform: translate(-50%, 50%);
        }

        /* Labels n√£o bloqueiam toques */
        #labels-container {
            pointer-events: none;
        }
    }

    /* Telas MUITO pequenas (celular compacto) */
    @media (max-width: 480px) {
        h1 {
            font-size: 1.15rem;
        }

        .subtitle {
            font-size: 0.72rem;
            padding-left: 8px;
        }

        .sim-controls .sim-btn {
            font-size: 0.65rem;
            padding: 7px 8px;
        }

        .neuro-footer {
            font-size: 0.6rem;
            gap: 4px;
        }

        .neuro-footer button {
            padding: 0 4px;
        }
    }

    /* Altura muito baixa (landscape em celular) */
    @media (max-height: 600px) {
        .hud-header {
            top: 8px;
        }

        .audio-toggle {
            top: 8px;
        }

        /* Em pouco espa√ßo vertical, tiramos o pacer pra nada parecer cortado */
        #breathing-pacer {
            display: none !important;
        }
    }

    #canvas-container {
        position: fixed;
        top:0; left:0;
        width: 100%; height: 100%;
        z-index: 1;
    }
</style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- BOOT SCREEN -->
    <div id="boot-screen">
        <div class="boot-inner">
            <div class="boot-scan-line"></div>
            <div class="boot-title">NEURAL CORE v9.5</div>
            <div class="boot-sub">Inicializando matriz sin√°ptica e monitor neuroqu√≠mico...</div>
            <div class="boot-log" id="boot-log"></div>
            <button class="boot-btn" id="boot-btn" onclick="showStartScreen()" style="display:none;">
                ENTRAR NO C√âREBRO <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- START SCREEN (Audio Context Requirement) -->
    <div id="start-screen">
        <h1 style="text-align: center; font-size: 3rem; text-shadow: 0 0 20px var(--neon-cyan);">NEUROATLAS<br><span style="font-size: 1.5rem; color: #fff; font-weight: 300;">SONIC EDITION</span></h1>
        <p style="color: #888; margin-top: 20px; font-family: 'Inter';">Experi√™ncia imersiva com √Åudio Binaural e Terapia Guiada.</p>
        <p style="color: #666; font-size: 0.8rem;">üéß Fones de ouvido recomendados</p>
        <button class="start-btn" onclick="initExperience()">INICIAR SISTEMA</button>
    </div>

    <!-- UI Layer -->
    <div id="ui-layer">
        <div class="neuro-grid"></div>

        <div class="hud-header">
            <h1>NeuroAtlas<span style="color:var(--neon-purple)">.IO</span></h1>
            <div class="subtitle">Mapeamento Terap√™utico Profundo</div>
        </div>

        <!-- Audio Toggle -->
        <div class="audio-toggle" onclick="toggleAudio()">
            <i class="bi bi-volume-up-fill" id="audio-icon"></i>
        </div>

        <!-- Breathing Pacer (Hidden by default) -->
        <div id="breathing-pacer">
            <div class="breath-circle"><i class="bi bi-lungs"></i></div>
            <div class="breath-text" id="breath-instruction">Respire com o ritmo...</div>
        </div>

        <!-- Controls -->
        <div class="sim-controls">
            <div class="sim-btn active" id="btn-homeo" onclick="setSimulation('normal', this)">
                <i class="bi bi-activity"></i> HOMEOSTASE
            </div>
            <div class="sim-btn anxiety-mode" id="btn-anxiety" onclick="setSimulation('anxiety', this)">
                <i class="bi bi-lightning-charge"></i> ANSIEDADE
            </div>
            <div class="sim-btn depress-mode" id="btn-depress" onclick="setSimulation('depression', this)">
                <i class="bi bi-cloud-fog2"></i> DEPRESS√ÉO
            </div>
            <div class="sim-btn perf-toggle" onclick="togglePerformance(this)">
                <i class="bi bi-cpu"></i> MODO PERFORMANCE
            </div>
        </div>

        <!-- Sess√µes Guiadas -->
        <div class="session-panel">
            <div class="session-title">Sess√µes Guiadas</div>
            <select id="session-select" class="session-select">
                <option value="antiAnxiety">Anti-crise de ansiedade ¬∑ 3 min</option>
                <option value="depressionLift">Sa√≠da da in√©rcia depressiva ¬∑ 3 min</option>
            </select>
            <div class="session-buttons">
                <button type="button" class="session-btn" onclick="startSelectedSession()">
                    <i class="bi bi-play-fill"></i> Iniciar
                </button>
                <button type="button" class="session-btn stop" onclick="stopSession()">
                    <i class="bi bi-stop-fill"></i> Parar
                </button>
            </div>
            <div class="session-status" id="session-status">Nenhuma sess√£o ativa</div>
        </div>

        <!-- Monitor Qu√≠mico -->
        <div class="chem-monitor">
            <div class="chem-title"><i class="bi bi-eyedropper"></i> N√≠veis Sin√°pticos</div>
            <div class="chem-row">
                <div class="chem-label"><span>CORTISOL</span> <span id="val-cortisol">15%</span></div>
                <div class="progress-bg"><div id="bar-cortisol" class="progress-fill" style="width: 15%; background: var(--alert-red)"></div></div>
            </div>
            <div class="chem-row">
                <div class="chem-label"><span>SEROTONINA</span> <span id="val-serotonin">80%</span></div>
                <div class="progress-bg"><div id="bar-serotonin" class="progress-fill" style="width: 80%; background: var(--serotonin-green)"></div></div>
            </div>
            <div class="chem-row">
                <div class="chem-label"><span>DOPAMINA</span> <span id="val-dopamine">65%</span></div>
                <div class="progress-bg"><div id="bar-dopamine" class="progress-fill" style="width: 65%; background: var(--dopamine-gold)"></div></div>
            </div>
            <div style="margin-top: 15px;">
                <div style="font-family:'JetBrains Mono';font-size:0.7rem;color:#94a3b8;margin-bottom:4px;text-transform:uppercase;">
                    Hist√≥rico (√∫ltimos 60s)
                </div>
                <canvas id="chem-chart" width="200" height="80"></canvas>
            </div>
        </div>

        <div id="labels-container"></div>

        <div class="neuro-footer">
            <span>NEUROATLAS ¬∑ SIMULADOR EDUCACIONAL</span>
            <button type="button" onclick="openScienceOverview()">CI√äNCIA+</button>
            <button type="button" onclick="openCircuitMap()">MAPA DE CIRCUITOS</button>
        </div>
    </div>

    <!-- 3D World -->
    <div id="canvas-container"></div>

    <!-- Modal Cient√≠fico Extra -->
    <div class="modal fade" id="science-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Mapa Neurocient√≠fico</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="science-modal-body"></div>
                    <small>‚ö† Conte√∫do com prop√≥sito <strong>educacional</strong>, n√£o substitui avalia√ß√£o cl√≠nica.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais (Estrutura) -->
    <div class="modal fade" id="generic-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-main-title">TITULO</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mode-indicator" id="modal-badge"></div>
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-1">Comportamento</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-2">Neurobiologia</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-1"><div id="content-behavior"></div></div>
                        <div class="tab-pane fade" id="tab-2"><div class="science-box" id="content-mech"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- AUDIO SYSTEM (Web Audio API) ---
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.droneOsc = null;
                this.droneGain = null;
                this.lfoOsc = null;
                this.lfoGain = null;
                this.isMuted = false;
            }

            init() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Master Drone
                this.droneOsc = this.ctx.createOscillator();
                this.droneGain = this.ctx.createGain();
                this.droneOsc.type = 'sine';
                this.droneOsc.frequency.value = 110; // A2 (Alpha waves range base)
                this.droneOsc.connect(this.droneGain);
                this.droneGain.connect(this.ctx.destination);
                this.droneGain.gain.value = 0; // Start silent
                this.droneOsc.start();

                // LFO for Pulse (Heartbeat effect)
                this.lfoOsc = this.ctx.createOscillator();
                this.lfoGain = this.ctx.createGain();
                this.lfoOsc.frequency.value = 1; // 1Hz pulse
                this.lfoGain.gain.value = 50; // Modulate drone freq
                this.lfoOsc.connect(this.lfoGain);
                // this.lfoGain.connect(this.droneOsc.frequency); // Connect modulation
                this.lfoOsc.start();
            }

            setMode(mode) {
                if(!this.ctx || this.isMuted) return;

                const now = this.ctx.currentTime;
                if(mode === 'normal') {
                    this.droneOsc.frequency.linearRampToValueAtTime(110, now + 2);
                    this.droneGain.gain.linearRampToValueAtTime(0.1, now + 2);
                } 
                else if (mode === 'anxiety') {
                    // High pitch, dissonance
                    this.droneOsc.frequency.linearRampToValueAtTime(330, now + 1); // E4
                    this.droneGain.gain.linearRampToValueAtTime(0.15, now + 1);
                } 
                else if (mode === 'depression') {
                    // Low pitch, rumble
                    this.droneOsc.frequency.linearRampToValueAtTime(55, now + 3); // A1
                    this.droneGain.gain.linearRampToValueAtTime(0.15, now + 3);
                }
            }

            toggle() {
                this.isMuted = !this.isMuted;
                if(this.ctx) {
                    this.droneGain.gain.setTargetAtTime(this.isMuted ? 0 : 0.1, this.ctx.currentTime, 0.1);
                }
                return this.isMuted;
            }
        }

        const audioSys = new AudioEngine();

        // --- CONTENT DATABASE EXPANDED ---
        const modalData = {
            'modal-amygdala': {
                title: 'AM√çGDALA (O Sentinela)',
                normal: { 
                    behavior: `
                        <p class="lead">O detector de relev√¢ncia emocional.</p>
                        <ul class="behavior-list">
                            <li><strong>Fun√ß√£o:</strong> Avalia o ambiente em milissegundos para identificar o que √© importante, seguro ou perigoso.</li>
                            <li><strong>Comportamento:</strong> Voc√™ se sente alerta, mas calmo. Consegue distinguir um perigo real (cobra) de um alarme falso (mangueira).</li>
                        </ul>`, 
                    mech: `<strong>Conex√£o Segura:</strong> O C√≥rtex Pr√©-Frontal (CEO) mant√©m uma linha direta inibit√≥ria com a Am√≠gdala via GABA, dizendo "est√° tudo bem, n√£o dispare".` 
                },
                anxiety: { 
                    behavior: `
                        <p class="lead" style="color:var(--alert-red)">Alarme de Inc√™ndio Travado.</p>
                        <ul class="behavior-list">
                            <li><strong>Hipervigil√¢ncia:</strong> O c√©rebro trata e-mails, olhares ou pensamentos como amea√ßas de morte (predadores).</li>
                            <li><strong>Sequestro Emocional:</strong> Dificuldade extrema em se acalmar racionalmente. Sensa√ß√£o f√≠sica de perigo iminente.</li>
                            <li><strong>Evita√ß√£o:</strong> O medo leva a evitar situa√ß√µes sociais ou lugares espec√≠ficos.</li>
                        </ul>`, 
                    mech: `<strong>Falha na Inibi√ß√£o:</strong> A conex√£o "freio" do Pr√©-Frontal falha. A Am√≠gdala hiperativa sequestra o eixo HPA, inundando o corpo de Adrenalina e Cortisol desnecessariamente.` 
                },
                depression: { 
                    behavior: `
                        <p class="lead" style="color:#aab2bd">O Vi√©s da Tristeza.</p>
                        <ul class="behavior-list">
                            <li><strong>Filtro Negativo:</strong> O c√©rebro ignora eventos felizes e foca obsessivamente em mem√≥rias de perda, culpa ou fracasso.</li>
                            <li><strong>Reatividade Sustentada:</strong> Quando algo ruim acontece, a am√≠gdala "segura" a emo√ß√£o negativa por muito mais tempo que o normal.</li>
                        </ul>`, 
                    mech: `<strong>Desregula√ß√£o L√≠mbica:</strong> Altera√ß√£o na sensibilidade. A am√≠gdala torna-se hipersens√≠vel a est√≠mulos tristes e cega para est√≠mulos de recompensa.` 
                }
            },
            'modal-pfc': {
                title: 'PR√â-FRONTAL (O Executivo)',
                normal: { 
                    behavior: `
                        <p class="lead">O Maestro da Orquestra.</p>
                        <ul class="behavior-list">
                            <li><strong>Fun√ß√£o:</strong> Planejamento, foco, controle de impulsos e regula√ß√£o das emo√ß√µes.</li>
                            <li><strong>Comportamento:</strong> Voc√™ consegue priorizar tarefas, controlar a frustra√ß√£o e manter a aten√ß√£o sustentada.</li>
                        </ul>`, 
                    mech: `<strong>Top-Down Control:</strong> Vias robustas de Glutamato permitem que a l√≥gica regule as √°reas emocionais primitivas.` 
                },
                anxiety: { 
                    behavior: `
                        <p class="lead" style="color:var(--alert-red)">O CEO em P√¢nico.</p>
                        <ul class="behavior-list">
                            <li><strong>Pensamento Acelerado:</strong> "E se..." catastr√≥fico. O c√©rebro simula dezenas de cen√°rios de desastre por minuto.</li>
                            <li><strong>Branco Mental:</strong> Sob press√£o, voc√™ esquece o que ia dizer. O excesso de ru√≠do neural bloqueia o acesso √† mem√≥ria.</li>
                            <li><strong>Paralisia por An√°lise:</strong> Medo excessivo de tomar a decis√£o errada.</li>
                        </ul>`, 
                    mech: `<strong>Curto-Circuito de Catecolaminas:</strong> N√≠veis excessivos de Dopamina e Noradrenalina no PFC "desligam" a atividade neuronal organizada, prejudicando a cogni√ß√£o.` 
                },
                depression: { 
                    behavior: `
                        <p class="lead" style="color:#aab2bd">O Sistema Offline.</p>
                        <ul class="behavior-list">
                            <li><strong>N√©voa Mental:</strong> Pensar parece exigir um esfor√ßo f√≠sico exaustivo. Sensa√ß√£o de lentid√£o.</li>
                            <li><strong>Avoli√ß√£o:</strong> Perda da "vontade". Voc√™ quer fazer algo, mas n√£o consegue iniciar a a√ß√£o motora.</li>
                            <li><strong>Indecis√£o:</strong> Dificuldade extrema at√© em escolhas triviais (ex: o que comer).</li>
                        </ul>`, 
                    mech: `<strong>Hipofrontalidade:</strong> Redu√ß√£o severa do fluxo sangu√≠neo e metabolismo no lobo frontal. Atrofia das espinhas dendr√≠ticas, reduzindo a conectividade sin√°ptica.` 
                }
            },
            'modal-hippo': {
                title: 'HIPOCAMPO (O Arquivista)',
                normal: { 
                    behavior: `
                        <p class="lead">O Guardi√£o da Mem√≥ria.</p>
                        <ul class="behavior-list">
                            <li><strong>Fun√ß√£o:</strong> Transforma experi√™ncias de curto prazo em mem√≥rias de longo prazo. Navega√ß√£o espacial e contextualiza√ß√£o.</li>
                            <li><strong>Comportamento:</strong> Voc√™ sabe onde deixou as chaves e distingue claramente o passado do presente.</li>
                        </ul>`, 
                    mech: `<strong>Neurog√™nese Adulta:</strong> O c√©rebro saud√°vel continua produzindo novos neur√¥nios nesta √°rea, facilitado pelo BDNF.` 
                },
                anxiety: { 
                    behavior: `
                        <p class="lead" style="color:var(--alert-red)">Mem√≥ria Fragmentada.</p>
                        <ul class="behavior-list">
                            <li><strong>D√©ficit de Aten√ß√£o:</strong> A mente est√° t√£o ocupada monitorando "amea√ßas" que n√£o grava o que algu√©m acabou de dizer.</li>
                            <li><strong>Generaliza√ß√£o:</strong> O medo de um evento espec√≠fico se espalha para contextos seguros (ex: medo de dirigir vira medo de sair de casa).</li>
                        </ul>`, 
                    mech: `<strong>Supress√£o da LTP:</strong> O cortisol elevado interfere na Potencia√ß√£o de Longa Dura√ß√£o, o mecanismo celular base da mem√≥ria.` 
                },
                depression: { 
                    behavior: `
                        <p class="lead" style="color:#aab2bd">O Arquivo Corrompido.</p>
                        <ul class="behavior-list">
                            <li><strong>Mem√≥ria Supergeneralizada:</strong> Dificuldade em lembrar detalhes espec√≠ficos de eventos felizes passados.</li>
                            <li><strong>Fus√£o Temporal:</strong> Sensa√ß√£o de que "todos os dias s√£o iguais". Perda da no√ß√£o de tempo.</li>
                        </ul>`, 
                    mech: `<strong>Neurotoxicidade:</strong> O estresse cr√¥nico √© t√≥xico para o hipocampo, causando redu√ß√£o f√≠sica de volume (atrofia) de at√© 20% em casos graves.` 
                }
            },
            'modal-acc': {
                title: 'CINGULADO (O Avaliador)',
                normal: { 
                    behavior: `
                        <p class="lead">O Detector de Conflitos.</p>
                        <ul class="behavior-list">
                            <li><strong>Fun√ß√£o:</strong> Monitora erros, expectativas n√£o atendidas e dor emocional.</li>
                            <li><strong>Comportamento:</strong> Voc√™ percebe um erro, corrige e segue em frente sem sofrimento excessivo.</li>
                        </ul>`, 
                    mech: `<strong>Sinaliza√ß√£o Eficiente:</strong> Comunica-se rapidamente com o Pr√©-Frontal para ajustar o comportamento diante de erros.` 
                },
                anxiety: { 
                    behavior: `
                        <p class="lead" style="color:var(--alert-red)">A Sirene de Erro.</p>
                        <ul class="behavior-list">
                            <li><strong>Obsess√£o:</strong> Preocupa√ß√£o constante de que algo est√° errado ou foi esquecido.</li>
                            <li><strong>Perfeccionismo T√≥xico:</strong> Medo paralisante de cometer qualquer erro, interpretando falhas pequenas como cat√°strofes.</li>
                        </ul>`, 
                    mech: `<strong>Hiperatividade do ERN:</strong> O sinal neural de "Negatividade Relacionada ao Erro" dispara com intensidade exagerada.` 
                },
                depression: { 
                    behavior: `
                        <p class="lead" style="color:#aab2bd">A Dor da Alma.</p>
                        <ul class="behavior-list">
                            <li><strong>Dor Ps√≠quica:</strong> A ang√∫stia da depress√£o √© processada aqui, muitas vezes sentida como uma dor f√≠sica real no peito ("cora√ß√£o partido").</li>
                            <li><strong>Rumina√ß√£o:</strong> Ficar preso em um loop mental repassando falhas e rejei√ß√µes passadas.</li>
                        </ul>`, 
                    mech: `<strong>Sobreposi√ß√£o de Dor:</strong> O Cingulado processa a dor social (rejei√ß√£o) usando os mesmos circuitos neurais da dor f√≠sica (corte, queimadura).` 
                }
            },
            'modal-insula': {
                title: '√çNSULA (O Sensor)',
                normal: { 
                    behavior: `
                        <p class="lead">A Consci√™ncia do Corpo.</p>
                        <ul class="behavior-list">
                            <li><strong>Fun√ß√£o:</strong> Interocep√ß√£o. Sente o que acontece dentro do corpo (fome, batimentos, temperatura) e gera sentimentos subjetivos.</li>
                            <li><strong>Comportamento:</strong> Voc√™ sente seu cora√ß√£o acelerar ao correr, mas sabe que √© exerc√≠cio, n√£o perigo.</li>
                        </ul>`, 
                    mech: `<strong>Integra√ß√£o Visceral:</strong> Mapeia dados do corpo para criar a sensa√ß√£o de "eu sinto".` 
                },
                anxiety: { 
                    behavior: `
                        <p class="lead" style="color:var(--alert-red)">O Amplificador de Sintomas.</p>
                        <ul class="behavior-list">
                            <li><strong>Catastrofiza√ß√£o Corporal:</strong> Uma leve taquicardia √© interpretada imediatamente como um ataque card√≠aco (P√¢nico).</li>
                            <li><strong>Sensa√ß√£o de Sufocamento:</strong> Falsa percep√ß√£o de falta de ar ("fome de ar") mesmo com oxigena√ß√£o normal.</li>
                        </ul>`, 
                    mech: `<strong>Erro de Predi√ß√£o Interoceptiva:</strong> O c√©rebro prev√™ sensa√ß√µes corporais negativas e amplifica o "volume" dos sinais viscerais reais.` 
                },
                depression: { 
                    behavior: `
                        <p class="lead" style="color:#aab2bd">O Corpo Pesado.</p>
                        <ul class="behavior-list">
                            <li><strong>Letargia F√≠sica:</strong> Sensa√ß√£o de que o corpo pesa toneladas ("paralisia de chumbo").</li>
                            <li><strong>Perda de Libido e Apetite:</strong> Desconex√£o com os impulsos vitais b√°sicos.</li>
                        </ul>`, 
                    mech: `<strong>Sickness Behavior:</strong> A √≠nsula sinaliza um estado sist√™mico similar a uma gripe infecciosa, ordenando ao corpo que conserve energia e se isole.` 
                }
            }
        };

        const scienceOverviewHTML = `
            <div class="science-section">
                <div class="science-section-title">Eixos Principais</div>
                <p style="font-size:0.9rem; color:#e2e8f0;">
                    O NeuroAtlas representa, de forma simplificada, a intera√ß√£o entre <strong>circuitos emocionais</strong>,
                    <strong>controle executivo</strong> e <strong>neuroqu√≠mica sist√™mica</strong>.
                </p>
                <div style="margin-bottom:10px;">
                    <span class="science-chip"><strong>Eixo HPA</strong>: Estresse &rarr; Cortisol</span>
                    <span class="science-chip"><strong>PFC ‚Üí Am√≠gdala</strong>: Inibi√ß√£o do medo</span>
                    <span class="science-chip"><strong>Hipocampo</strong>: Contexto das mem√≥rias</span>
                    <span class="science-chip"><strong>√çnsula</strong>: Consci√™ncia corporal</span>
                    <span class="science-chip"><strong>Cingulado</strong>: Erro, dor emocional</span>
                </div>
            </div>
            <hr class="text-secondary">
            <div class="science-section">
                <div class="science-section-title">Estados de Simula√ß√£o</div>
                <p style="font-size:0.9rem; color:#cbd5e1;">
                    Cada modo de simula√ß√£o (<strong>Homeostase</strong>, <strong>Ansiedade</strong>, <strong>Depress√£o</strong>)
                    ajusta tr√™s camadas ao mesmo tempo:
                </p>
                <ul style="font-size:0.9rem; color:#e5e7eb;">
                    <li><strong>Visual</strong>: Cor base das fibras, intensidade das part√≠culas, rota√ß√£o.</li>
                    <li><strong>Neuroqu√≠mica</strong>: N√≠veis relativos de cortisol, serotonina e dopamina.</li>
                    <li><strong>Som</strong>: Altura do tom e intensidade do drone binaural.</li>
                </ul>
            </div>
            <hr class="text-secondary">
            <div class="science-section">
                <div class="science-section-title">Limita√ß√µes e √âtica</div>
                <p style="font-size:0.8rem; color:#94a3b8;">
                    Este modelo √© uma <strong>visualiza√ß√£o did√°tica</strong>, n√£o um simulador cl√≠nico real.  
                    Serve para entender conceitos como <em>hiperatividade amigdalar</em>, <em>hipofrontalidade</em> e
                    <em>neurotoxicidade do estresse cr√¥nico</em> de forma visual e intuitiva.
                </p>
            </div>
        `;

        const circuitMapHTML = `
            <div class="science-section">
                <div class="science-section-title">Mapa de Circuitos Funcionais</div>
                <ul style="font-size:0.9rem; color:#e5e7eb; margin-bottom:10px;">
                    <li><strong>PFC ‚áÑ Am√≠gdala:</strong> Quando o PFC est√° forte, ele "conversa" com a am√≠gdala e reavalia amea√ßas. Em ansiedade cr√¥nica, esse freio falha.</li>
                    <li><strong>Am√≠gdala ‚Üí HPA ‚Üí Cortisol:</strong> Alerta de perigo ativa eixo hipot√°lamo‚Äìhip√≥fise‚Äìadrenal, elevando cortisol.</li>
                    <li><strong>Hipocampo ‚áÑ Am√≠gdala:</strong> O hipocampo fornece <em>contexto</em>: "isso √© passado", "isso √© mem√≥ria". Sob estresse cr√¥nico, essa modula√ß√£o enfraquece.</li>
                    <li><strong>Cingulado Anterior:</strong> Monitora erros, rejei√ß√£o e dor emocional, influenciando tanto am√≠gdala quanto PFC.</li>
                    <li><strong>√çnsula:</strong> Integra sinais corporais (batimentos, respira√ß√£o) e colore a experi√™ncia subjetiva de ansiedade ou apatia.</li>
                </ul>
            </div>
            <div class="science-section">
                <div class="science-section-title">Leitura do Monitor Qu√≠mico</div>
                <ul style="font-size:0.9rem; color:#cbd5e1;">
                    <li><strong>Cortisol alto + PFC inst√°vel:</strong> tend√™ncia a pensamento catastr√≥fico, hipervigil√¢ncia.</li>
                    <li><strong>Serotonina baixa:</strong> dificuldade em sentir prazer b√°sico, humor rebaixado.</li>
                    <li><strong>Dopamina muito baixa:</strong> perda de motiva√ß√£o e energia para iniciar a√ß√µes.</li>
                </ul>
            </div>
        `;

        window.openScienceOverview = () => {
            const body = document.getElementById('science-modal-body');
            body.innerHTML = scienceOverviewHTML;
            const modal = new bootstrap.Modal(document.getElementById('science-modal'));
            modal.show();
        };

        window.openCircuitMap = () => {
            const body = document.getElementById('science-modal-body');
            body.innerHTML = circuitMapHTML;
            const modal = new bootstrap.Modal(document.getElementById('science-modal'));
            modal.show();
        };

        // --- STATE ---
        const state = {
            mode: 'normal',
            baseColor: new THREE.Color(0x00f3ff),
            flowSpeed: 0.002,
            cameraFocus: null, // { pos: Vector3, target: Vector3 } or null
            defaultCamPos: new THREE.Vector3(0, 0, 14),
            performanceMode: false
        };

        let isTabActive = true;
        document.addEventListener('visibilitychange', () => {
            isTabActive = !document.hidden;
        });

        const container = document.getElementById('canvas-container');
        const labelContainer = document.getElementById('labels-container');
        const labels = [];

        const btnHomeo = document.getElementById('btn-homeo');
        const btnAnxiety = document.getElementById('btn-anxiety');
        const btnDepress = document.getElementById('btn-depress');
        
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020408, 0.035);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.copy(state.defaultCamPos);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ReinhardToneMapping;
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.minDistance = 2;
        controls.maxDistance = 20;
        controls.enablePan = false;

        const composer = new EffectComposer(renderer);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.strength = 2.0;
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(bloomPass);

        // --- 3D ASSETS ---
        const brainGroup = new THREE.Group();
        scene.add(brainGroup);

        // Fibers
        function createFibers() {
            const fiberCount = 300;
            const curvePoints = [];
            const colors = [];
            const geometry = new THREE.BufferGeometry();
            const material = new THREE.LineBasicMaterial({ vertexColors: true, transparent: true, opacity: 0.15, blending: THREE.AdditiveBlending });
            const positions = [];
            
            for(let i=0; i<fiberCount; i++) {
                const p1 = new THREE.Vector3((Math.random()-0.5)*3, (Math.random()-0.5)*3, (Math.random()-0.5)*3);
                const p2 = new THREE.Vector3((Math.random()-0.5)*5, (Math.random()-0.5)*4, (Math.random()-0.5)*5);
                const p3 = new THREE.Vector3((Math.random()-0.5)*5, (Math.random()-0.5)*4, (Math.random()-0.5)*5);
                const p4 = new THREE.Vector3((Math.random()-0.5)*3, (Math.random()-0.5)*3, (Math.random()-0.5)*3);
                const curve = new THREE.CubicBezierCurve3(p1, p2, p3, p4);
                const points = curve.getPoints(20);
                for(let j=0; j<points.length-1; j++) {
                    positions.push(points[j].x, points[j].y, points[j].z);
                    positions.push(points[j+1].x, points[j+1].y, points[j+1].z);
                    const c1 = new THREE.Color(0x00f3ff); const c2 = new THREE.Color(0xbc13fe);
                    colors.push(c1.r, c1.g, c1.b); colors.push(c2.r, c2.g, c2.b);
                }
                curvePoints.push(curve);
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            const fibers = new THREE.LineSegments(geometry, material);
            brainGroup.add(fibers);
            return { curveObjects: curvePoints };
        }
        const tractography = createFibers();

        // Particles
        const particleCount = 400;
        const particleGeo = new THREE.BufferGeometry();
        const particlePos = new Float32Array(particleCount * 3);
        const particleProgress = new Float32Array(particleCount);
        const particleCurveIndex = new Int16Array(particleCount);
        for(let i=0; i<particleCount; i++) {
            particleProgress[i] = Math.random();
            particleCurveIndex[i] = Math.floor(Math.random() * tractography.curveObjects.length);
        }
        particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePos, 3));
        const particles = new THREE.Points(
            particleGeo,
            new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.08,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            })
        );
        brainGroup.add(particles);

        // Hotspots
        function addLabel(x,y,z, id, text) {
            const g = new THREE.Group();
            g.position.set(x,y,z);
            const sphere = new THREE.Mesh(new THREE.IcosahedronGeometry(0.12, 1), new THREE.MeshBasicMaterial({color:0xffffff}));
            const halo = new THREE.Mesh(new THREE.SphereGeometry(0.25, 16, 16), new THREE.MeshBasicMaterial({color:0x00f3ff, transparent:true, opacity:0.3}));
            g.add(sphere); g.add(halo);
            g.userData = { modalId: id, isHotspot: true, focusPos: new THREE.Vector3(x*1.5, y*1.5, z + 4) }; // Camera target offset
            brainGroup.add(g);
            const el = document.createElement('div');
            el.className = 'hotspot-label';
            el.innerHTML = `${text}<div class="line-connector"></div>`;
            labelContainer.appendChild(el);
            labels.push({obj: g, el: el});
        }
        addLabel(0, -0.8, 1.8, 'modal-amygdala', 'AM√çGDALA');
        addLabel(0, 1.8, 1.2, 'modal-pfc', 'PR√â-FRONTAL');
        addLabel(-1.5, -0.3, 0.8, 'modal-hippo', 'HIPOCAMPO');
        addLabel(0, 0.5, 1.5, 'modal-acc', 'CINGULADO');
        addLabel(1.5, -0.2, 1.0, 'modal-insula', '√çNSULA');

        // --- BOOT SEQUENCE ---
        function runBootSequence() {
            const logEl = document.getElementById('boot-log');
            const btn = document.getElementById('boot-btn');

            const lines = [
                '[BOOT] Carregando matriz de conectividade cortical...',
                '[OK]  Tratos fronto-l√≠mbicos inicializados.',
                '[BOOT] Sincronizando PFC ‚áÑ Am√≠gdala...',
                '[OK]  Inibi√ß√£o top-down funcional.',
                '[BOOT] Ativando eixo HPA (modo simulado)...',
                '[OK]  Cortisol pronto para modula√ß√£o visual.',
                '[BOOT] Mapeando hipocampo e indexando mem√≥rias contextuais...',
                '[BOOT] Integrando sinais da √çnsula (interocep√ß√£o)...',
                '[OK]  Mapa visceral dispon√≠vel.',
                '[BOOT] Cingulado anterior: monitor de erro e dor emocional online.',
                '[OK]  Painel de estados pronto.',
                '[SYS]  Renderizador 3D carregado. Part√≠culas sin√°pticas em standby.',
                '[SYS]  Modo SONIC pronto para acoplamento ao usu√°rio.',
                '',
                '>>> Pressione ENTRAR NO C√âREBRO para iniciar a sess√£o interativa.'
            ];

            let idx = 0;
            const interval = setInterval(() => {
                if (idx >= lines.length) {
                    clearInterval(interval);
                    btn.style.display = 'inline-flex';
                    return;
                }
                const line = document.createElement('div');
                line.textContent = lines[idx];
                logEl.appendChild(line);
                logEl.scrollTop = logEl.scrollHeight;
                idx++;
            }, 230);
        }

        window.showStartScreen = () => {
            const boot = document.getElementById('boot-screen');
            const start = document.getElementById('start-screen');
            boot.style.opacity = '0';
            setTimeout(() => {
                boot.style.display = 'none';
                start.style.display = 'flex';
                requestAnimationFrame(() => {
                    start.style.opacity = '1';
                });
            }, 600);
        };

        runBootSequence();

        // --- CHEM STATE & CHART ---
        const chemState = { c: 15, s: 80, d: 65 };

        const chemChartCanvas = document.getElementById('chem-chart');
        const chemChartCtx = chemChartCanvas.getContext('2d');
        const chemHistory = { c: [], s: [], d: [] };
        const maxHistoryPoints = 60;

        function recordChemHistory() {
            chemHistory.c.push(chemState.c);
            chemHistory.s.push(chemState.s);
            chemHistory.d.push(chemState.d);
            ['c', 's', 'd'].forEach(k => {
                if (chemHistory[k].length > maxHistoryPoints) chemHistory[k].shift();
            });
            drawChemChart();
        }

        function drawChemChart() {
            const ctx = chemChartCtx;
            const w = chemChartCanvas.width;
            const h = chemChartCanvas.height;
            ctx.clearRect(0, 0, w, h);

            // fundo
            ctx.fillStyle = 'rgba(15,23,42,0.95)';
            ctx.fillRect(0, 0, w, h);

            // grid
            ctx.strokeStyle = 'rgba(148,163,184,0.25)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i <= 4; i++) {
                const y = (h - 10) * (i / 4) + 5;
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
            }
            ctx.stroke();

            const drawLine = (data, color) => {
                if (data.length < 2) return;
                ctx.strokeStyle = color;
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                data.forEach((val, idx) => {
                    const x = (w - 10) * (idx / (maxHistoryPoints - 1)) + 5;
                    const y = h - 5 - (h - 10) * (val / 100);
                    if (idx === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            };

            drawLine(chemHistory.c, '#ff2a2a');
            drawLine(chemHistory.s, '#00ff9d');
            drawLine(chemHistory.d, '#ffcc00');
        }

        setInterval(recordChemHistory, 1000);

        // --- SESS√ïES GUIADAS ---
        const sessionConfigs = {
            antiAnxiety: {
                label: 'Anti-crise de ansiedade',
                duration: 180,
                relaxStart: 30,
                modeStart: 'anxiety',
                targetChem: { c: 20, s: 80, d: 60 }
            },
            depressionLift: {
                label: 'Sa√≠da da in√©rcia depressiva',
                duration: 180,
                relaxStart: 20,
                modeStart: 'depression',
                targetChem: { c: 30, s: 65, d: 55 }
            }
        };

        let sessionState = {
            active: false,
            type: null,
            elapsed: 0,
            duration: 0,
            timerId: null,
            label: '',
            startChem: null,
            config: null
        };

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function updateSessionStatus() {
            const el = document.getElementById('session-status');
            if (!el) return;
            if (!sessionState.active) {
                el.textContent = 'Nenhuma sess√£o ativa';
                return;
            }
            const remaining = Math.max(0, sessionState.duration - sessionState.elapsed);
            el.textContent = `${sessionState.label} ‚Äì restante ${formatTime(remaining)}`;
        }

        function startSession(type) {
            const config = sessionConfigs[type];
            if (!config) return;

            // Se j√° tiver sess√£o rodando, encerra silenciosamente
            stopSession(true);

            sessionState = {
                active: true,
                type,
                elapsed: 0,
                duration: config.duration,
                timerId: null,
                label: config.label,
                startChem: null,
                config
            };

            // Ajusta modo inicial
            if (config.modeStart === 'anxiety') {
                setSimulation('anxiety');
            } else if (config.modeStart === 'depression') {
                setSimulation('depression');
            } else {
                setSimulation('normal');
            }

            // captura qu√≠mica inicial ap√≥s setSimulation
            sessionState.startChem = { ...chemState };

            updateSessionStatus();

            sessionState.timerId = setInterval(() => {
                if (!sessionState.active || !sessionState.config) return;

                sessionState.elapsed++;

                const cfg = sessionState.config;

                if (sessionState.elapsed >= cfg.relaxStart) {
                    const tRaw = (sessionState.elapsed - cfg.relaxStart) / (cfg.duration - cfg.relaxStart);
                    const t = Math.max(0, Math.min(1, tRaw));

                    const nc = Math.round(sessionState.startChem.c + (cfg.targetChem.c - sessionState.startChem.c) * t);
                    const ns = Math.round(sessionState.startChem.s + (cfg.targetChem.s - sessionState.startChem.s) * t);
                    const nd = Math.round(sessionState.startChem.d + (cfg.targetChem.d - sessionState.startChem.d) * t);
                    updateChem(nc, ns, nd);
                }

                updateSessionStatus();

                if (sessionState.elapsed >= cfg.duration) {
                    // encerra levando para homeostase
                    setSimulation('normal');
                    stopSession(true);
                    updateSessionStatus();
                }
            }, 1000);
        }

        window.startSelectedSession = () => {
            const select = document.getElementById('session-select');
            if (!select) return;
            startSession(select.value);
        };

        window.stopSession = (silent) => {
            if (sessionState.timerId) {
                clearInterval(sessionState.timerId);
            }
            sessionState.timerId = null;
            sessionState.active = false;
            sessionState.type = null;
            sessionState.config = null;
            if (!silent) {
                updateSessionStatus();
            }
        };

        // --- FUNCTIONS ---

        window.initExperience = () => {
            const start = document.getElementById('start-screen');
            start.style.opacity = 0;
            setTimeout(() => start.style.display = 'none', 800);
            audioSys.init();
            audioSys.setMode('normal');
        };

        window.toggleAudio = () => {
            const muted = audioSys.toggle();
            const icon = document.getElementById('audio-icon');
            icon.className = muted ? 'bi bi-volume-mute-fill' : 'bi bi-volume-up-fill';
            icon.style.color = muted ? '#666' : 'var(--neon-cyan)';
        };

        function updateModal(modalId) {
            const data = modalData[modalId];
            const currentData = data[state.mode];
            
            document.getElementById('modal-main-title').innerText = data.title;
            document.getElementById('content-behavior').innerHTML = currentData.behavior;
            document.getElementById('content-mech').innerHTML = currentData.mech;
            
            const badge = document.getElementById('modal-badge');
            badge.innerText = state.mode.toUpperCase();
            
            // Badge Colors
            if(state.mode === 'normal') { badge.style.background = 'rgba(0, 243, 255, 0.2)'; badge.style.color = '#00f3ff'; }
            else if(state.mode === 'anxiety') { badge.style.background = 'rgba(255, 42, 42, 0.2)'; badge.style.color = '#ff2a2a'; }
            else { badge.style.background = 'rgba(100, 116, 139, 0.2)'; badge.style.color = '#cbd5e1'; }
        }

        // Interaction
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        window.addEventListener('pointerdown', (e) => {
            if(e.target.closest('.sim-controls') || e.target.closest('.chem-monitor') || e.target.closest('.session-panel')) return;
            
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(brainGroup.children, true);
            if(intersects.length > 0) {
                let target = intersects[0].object;
                while(target.parent && !target.userData.isHotspot) target = target.parent;
                if(target.userData.isHotspot) {
                    updateModal(target.userData.modalId);
                    
                    // Cinematic Focus
                    state.cameraFocus = { 
                        pos: target.userData.focusPos.clone(), 
                        lookAt: target.position.clone() 
                    };
                    
                    const myModal = new bootstrap.Modal(document.getElementById('generic-modal'));
                    myModal.show();
                    
                    // Reset camera when modal closes
                    document.getElementById('generic-modal').addEventListener('hidden.bs.modal', () => {
                        state.cameraFocus = null;
                    }, { once: true });
                }
            }
        });

        function updateChem(c, s, d) {
            chemState.c = c;
            chemState.s = s;
            chemState.d = d;
            document.getElementById('bar-cortisol').style.width = c + '%'; document.getElementById('val-cortisol').innerText = c + '%';
            document.getElementById('bar-serotonin').style.width = s + '%'; document.getElementById('val-serotonin').innerText = s + '%';
            document.getElementById('bar-dopamine').style.width = d + '%'; document.getElementById('val-dopamine').innerText = d + '%';
        }

        // Simulation Control
        window.setSimulation = (mode, btn) => {
            // limpa active dos modos principais
            document.querySelectorAll('.sim-btn').forEach(b => {
                if (!b.classList.contains('perf-toggle')) {
                    b.classList.remove('active');
                }
            });

            if (!btn) {
                if (mode === 'normal') btn = btnHomeo;
                else if (mode === 'anxiety') btn = btnAnxiety;
                else if (mode === 'depression') btn = btnDepress;
            }

            if (btn) {
                btn.classList.add('active');
            }

            state.mode = mode;
            audioSys.setMode(mode);

            const pacer = document.getElementById('breathing-pacer');

            if(mode === 'normal') {
                updateChem(15, 80, 65);
                state.baseColor.setHex(0x00f3ff);
                state.flowSpeed = 0.002;
                pacer.style.display = 'none'; pacer.style.opacity = 0;
            } else if (mode === 'anxiety') {
                updateChem(95, 40, 85);
                state.baseColor.setHex(0xff2a2a);
                state.flowSpeed = 0.008;
                // Activate Breathing Pacer
                pacer.style.display = 'flex';
                setTimeout(() => pacer.style.opacity = 1, 100);
            } else if (mode === 'depression') {
                updateChem(40, 20, 15);
                state.baseColor.setHex(0x64748b);
                state.flowSpeed = 0.0005;
                pacer.style.display = 'none'; pacer.style.opacity = 0;
            }
        };

        window.togglePerformance = (btn) => {
            state.performanceMode = !state.performanceMode;
            if (btn) {
                btn.classList.toggle('active', state.performanceMode);
            }

            if (state.performanceMode) {
                // Reduz um pouco o custo gr√°fico
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
                bloomPass.strength = 1.2;
                particles.material.size = 0.06;
                particles.material.needsUpdate = true;
            } else {
                // Volta para o padr√£o original
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                bloomPass.strength = 2.0;
                particles.material.size = 0.08;
                particles.material.needsUpdate = true;
            }
        };

        // Loop
        function animate() {
            requestAnimationFrame(animate);

            // Se a aba n√£o estiver ativa e n√£o estiver em modo performance, simplifica
            if (!isTabActive && !state.performanceMode) {
                composer.render();
                return;
            }
            
            // Camera Logic
            if(state.cameraFocus) {
                // Cinematic Zoom
                camera.position.lerp(state.cameraFocus.pos, 0.05);
                controls.target.lerp(state.cameraFocus.lookAt, 0.05);
            } else {
                // Idle Float
                controls.target.lerp(new THREE.Vector3(0,0,0), 0.05);
                brainGroup.rotation.y += 0.001;
            }
            controls.update();

            // Particles
            const positions = particles.geometry.attributes.position.array;
            for(let i=0; i<particleCount; i++) {
                particleProgress[i] += state.flowSpeed;
                if(particleProgress[i] > 1) particleProgress[i] = 0;
                const curve = tractography.curveObjects[particleCurveIndex[i]];
                const point = curve.getPoint(particleProgress[i]);
                positions[i*3] = point.x; positions[i*3+1] = point.y; positions[i*3+2] = point.z;
            }
            particles.geometry.attributes.position.needsUpdate = true;
            particles.material.color.lerp(state.baseColor, 0.05);

            // Labels
            labels.forEach(l => {
                const pos = new THREE.Vector3(); l.obj.getWorldPosition(pos); pos.project(camera);
                if(pos.z > 1) {
                    l.el.style.opacity = 0;
                } else {
                    l.el.style.opacity = 0.8;
                    const x = (pos.x * .5 + .5) * container.clientWidth;
                    const y = (pos.y * -.5 + .5) * container.clientHeight;
                    l.el.style.transform = `translate(-50%, -100%) translate(${x}px, ${y-20}px)`;
                }
            });

            composer.render();
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
